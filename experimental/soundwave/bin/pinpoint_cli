#!/usr/bin/env python
# Copyright 2018 The Chromium Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

import argparse
import os
import sys

import oauth2client.tools

ROOT_PATH = os.path.normpath(os.path.join(os.path.dirname(__file__), '..'))
PY_UTILS_PATH = os.path.normpath(os.path.join(
    ROOT_PATH, '..', '..', 'common', 'py_utils'))

sys.path.append(ROOT_PATH)
sys.path.append(PY_UTILS_PATH)

from common import utils
from services import chrome_perf_auth
from services import pinpoint_service


def main():
  parser = argparse.ArgumentParser(parents=[oauth2client.tools.argparser])
  parser.add_argument('--repository', default='chromium')
  parser.add_argument('--revision', required=True)
  parser.add_argument('--patch', required=True)
  parser.add_argument(
      '-v', '--verbose', action='count', default=0,
      help='Increase verbosity level')
  args = parser.parse_args()
  utils.ConfigureLogging(args.verbose)

  credentials = chrome_perf_auth.GetUserCredentials(args)
  api = pinpoint_service.Api(credentials)

  print api.NewJob(
      name='Test job from command line',
      configuration='android-go-perf',
      target='performance_test_suite',
      benchmark='system_health.memory_mobile',
      extra_test_args='--story-tag-filter health_check',
      repository=args.repository,
      start_git_hash=args.revision,
      end_git_hash=args.revision,
      patch=args.patch)


if __name__ == '__main__':
  sys.exit(main())
