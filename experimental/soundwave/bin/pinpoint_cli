#!/usr/bin/env python
# Copyright 2018 The Chromium Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

import argparse
import os
import re
import sys

import oauth2client.tools

ROOT_PATH = os.path.normpath(os.path.join(os.path.dirname(__file__), '..'))
PY_UTILS_PATH = os.path.normpath(os.path.join(
    ROOT_PATH, '..', '..', 'common', 'py_utils'))

sys.path.append(ROOT_PATH)
sys.path.append(PY_UTILS_PATH)

from common import utils
from services import chrome_perf_auth
from services import pinpoint_service


def main():
  parser = argparse.ArgumentParser(parents=[oauth2client.tools.argparser])
  parser.add_argument(
      '-v', '--verbose', action='count', default=0,
      help='Increase verbosity level')
  subparsers = parser.add_subparsers(dest='action')
  subparsers.required = True
  # Subparser args for getting state of a job.
  subparser = subparsers.add_parser('job')
  subparser.add_argument('job_id')
  # Subparser args for creating a new job.
  subparser = subparsers.add_parser('new-job')
  args = parser.parse_args()
  utils.ConfigureLogging(args.verbose)

  credentials = chrome_perf_auth.GetUserCredentials(args)
  api = pinpoint_service.Api(credentials)

  if args.action == 'job':
    print api.Job(args.job_id, with_state=True)
  elif args.action == 'new-job':
    metric = 'memory:chrome:all_processes:reported_by_chrome:malloc:allocated_objects_size'
    story = 'browse:media:facebook_photos'
    tir_label = story.split(':', 1)[0]
    story_pattern = re.sub(r'[\W_]', '.', story)

    print api.NewJob(
        name='Bisect job created from command line',
        bug_id='876006',
        comparison_mode='performance',
        statistic='avg',
        configuration='android-nexus5x-perf',
        target='performance_test_suite',
        benchmark='system_health.memory_mobile',
        chart=metric, trace=story, story=story_pattern, tir_label=tir_label,
        extra_test_args='--extra-test-args-here',
        repository='chromium',
        start_git_hash='323f860eb0cfafe56bb784b5f9674d6d6b15ea05',
        end_git_hash='df2f20cc8e9d321b75ee1953ba6160a9125c9e3f',
        patch=args.patch)
  else:
    raise NotImplementedError(args.action)


if __name__ == '__main__':
  sys.exit(main())
