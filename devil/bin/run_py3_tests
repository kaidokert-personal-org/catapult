#!/usr/bin/env vpython3
# Copyright 2020 The Chromium Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

"""Runs all python3-compatible tests in devil."""

import os
import sys
import unittest

import six

_DEVIL_PATH = os.path.abspath(os.path.join(os.path.dirname(__file__), '..'))

sys.path.append(_DEVIL_PATH)
import devil.devil_env_test
import devil.utils.cmd_helper_test
import devil.utils.decorators_test
import devil.utils.find_usb_devices_test
import devil.utils.geometry_test
import devil.utils.lsusb_test
import devil.utils.markdown_test
import devil.utils.mock_calls_test
import devil.utils.parallelizer_test
import devil.utils.reraiser_thread_unittest
import devil.utils.timeout_retry_unittest
import devil.utils.zip_utils_test

PY3_COMPATIBLE_TESTS = [
    devil.devil_env_test,
    devil.utils.cmd_helper_test,
    devil.utils.decorators_test,
    devil.utils.find_usb_devices_test,
    devil.utils.geometry_test,
    devil.utils.lsusb_test,
    devil.utils.markdown_test,
    devil.utils.mock_calls_test,
    devil.utils.parallelizer_test,
    devil.utils.reraiser_thread_unittest,
    devil.utils.timeout_retry_unittest,
    devil.utils.zip_utils_test,
]


def main():
  if six.PY2:
    print('Somehow running under python2.')
    return 1

  # Tests mock out internal details of methods, and the ANDROID_SERIAL can
  # change which internal methods are called. Since tests don't actually use
  # devices, it should be fine to delete the variable.
  if 'ANDROID_SERIAL' in os.environ:
    del os.environ['ANDROID_SERIAL']

  # This does not use typ for now, as typ has vpython dependencies that haven't
  # yet been updated for python3.
  result = unittest.TextTestRunner().run(unittest.TestSuite(
      unittest.defaultTestLoader.loadTestsFromModule(test_module)
      for test_module in PY3_COMPATIBLE_TESTS
  ))

  return 0 if result.wasSuccessful() else 1



if __name__ == '__main__':
  sys.exit(main())
