<!DOCTYPE html>
<!--
Copyright 2016 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="/tracing/base/timing.html">
<link rel="import" href="/tracing/base/unit.html">
<link rel="import" href="/tracing/ui/base/name_line_chart.html">
<link rel="import" href="/tracing/value/ui/histogram_span.html">
<link rel="import" href="/tracing/value/ui/scalar_span.html">

<dom-module id="tr-v-ui-histogram-set-table-cell">
  <template>
    <style>
    #documentation {
      color: var(--paper-indigo-500);
      flex-shrink: 0;
    }

    paper-input {
      --paper-input-container: {
        padding: 0;
      }
    }

    #panel_toggles paper-button {
      justify-content: flex-start;
      margin: 0;
      padding: 0;
      width: 100%;
    }
    #panel_toggles {
      margin-top: 8px;
      align-items: start;
    }
    #missing, #empty, #unmergeable, #scalar {
      flex-grow: 1;
    }

    #scalar {
      flex-grow: 1;
      white-space: nowrap;
    }

    #histogram {
      flex-grow: 1;
    }

    #overview_container {
      display: none;
    }

    #expand {
      margin: 0;
      padding: 0;
      width: 100%;
    }

    flex {
      display: flex;
    }
    flex[column] {
      flex-direction: column;
    }
    .noshrink {
      flex-shrink: 0;
    }

    iron-icon {
      height: 1em;
    }

    iron-collapse[horizontal] {
      width: 100%;
    }
    </style>

    <flex>
      <iron-collapse horizontal opened="[[isMissing_(histogram)]]">
        (missing)
      </iron-collapse>
      <iron-collapse horizontal opened="[[isEmpty_(histogram)]]">
        (empty)
      </iron-collapse>
      <iron-collapse horizontal opened="[[isUnmergeable_(histogram)]]">
        (unmergeable)
      </iron-collapse>

      <iron-collapse horizontal opened="[[isBisectExpanded]]">
        <paper-input label="Bug ID">
        </paper-input>
        <paper-input label="Start revision" value="123456">
        </paper-input>
        <paper-input label="End revision" value="234567">
        </paper-input>
        <paper-checkbox style="margin-top: 8px;">
          Staging bots
        </paper-checkbox>

        <div style="display: flex;">
          <paper-button style="color: var(--paper-indigo-500); font-weight: bold;">
            Start Bisect
          </paper-button>
          <a id="documentation"
             href="#"
             target="_blank"
             title="Documentation">
            <paper-icon-button icon="help"></paper-icon-button>
          </a>
        </div>
      </iron-collapse>

      <iron-collapse horizontal opened="[[isSamplesExpanded]]">
        TODO bar chart
        <paper-checkbox style="display: block;">
          Merge Sample Diagnostics
        </paper-checkbox>
        TODO sample diagnostics table
        <tr-v-ui-diagnostic-map-table id="sample_diagnostics">
        </tr-v-ui-diagnostic-map-table>
      </iron-collapse>

      <iron-collapse horizontal opened="[[isMetadataExpanded]]">
        TODO metadata diagnostics table
        <tr-v-ui-diagnostic-map-table id="metadata_diagnostics">
        </tr-v-ui-diagnostic-map-table>
      </iron-collapse>

      <iron-collapse horizontal opened="[[isValid_(histogram)]]">
        <flex column>
          <paper-button id="expand" on-tap="toggleExpanded_" style="text-transform: none;">
            <flex style="width: 100%;">
              <template is="dom-if" if="[[!isExpanded]]">
                <iron-icon icon="expand-more" class="noshrink">
                </iron-icon>
              </template>
              <template is="dom-if" if="[[isExpanded]]">
                <iron-icon icon="expand-less" class="noshrink">
                </iron-icon>
              </template>
              <iron-collapse horizontal opened="[[!isExpanded]]">
                <tr-v-ui-scalar-span id="scalar">
                </tr-v-ui-scalar-span>
              </iron-collapse>

              <iron-collapse horizontal opened="[[isExpanded]]">
                <tr-v-ui-scalar-map-table id="stats">
                </tr-v-ui-scalar-map-table>
              </iron-collapse>
            </flex>
          </paper-button>

          <iron-collapse opened="[[isExpanded]]">
            <flex column id="panel_toggles">
              <paper-button on-tap="toggleBisect_">
                <template is="dom-if" if="[[!isBisectExpanded]]">
                  <iron-icon icon="chevron-left" />
                </template>

                <template is="dom-if" if="[[isBisectExpanded]]">
                  <iron-icon icon="chevron-right" />
                </template>

                Bisect
              </paper-button>

              <paper-button on-tap="toggleSamples_">
                <template is="dom-if" if="[[!isSamplesExpanded]]">
                  <iron-icon icon="chevron-left" />
                </template>

                <template is="dom-if" if="[[isSamplesExpanded]]">
                  <iron-icon icon="chevron-right" />
                </template>

                Samples
              </paper-button>

              <paper-button on-tap="toggleMetadata_">
                <template is="dom-if" if="[[!isMetadataExpanded]]">
                  <iron-icon icon="chevron-left" />
                </template>

                <template is="dom-if" if="[[isMetadataExpanded]]">
                  <iron-icon icon="chevron-right" />
                </template>

                Metadata
              </paper-button>
            </flex>
          </iron-collapse>
        </flex>
      </iron-collapse>
    </flex>

    <div id="overview_container">
    </div>
  </template>
</dom-module>

<script>
'use strict';
tr.exportTo('tr.v.ui', function() {
  Polymer({
    is: 'tr-v-ui-histogram-set-table-cell',

    properties: {
      histogram: {
        type: Object,
        value: undefined,
      },
      isExpanded: {
        type: Boolean,
        value: false,
      },
      isBisectExpanded: {
        type: Boolean,
        value: false,
      },
      isSamplesExpanded: {
        type: Boolean,
        value: false,
      },
      isMetadataExpanded: {
        type: Boolean,
        value: false,
      },
    },

    created() {
      this.viewState_ = undefined;
      this.rootListener_ = this.onRootStateUpdate_.bind(this);
      this.row_ = undefined;
      this.displayLabel_ = '';
      this.histogramSpan_ = undefined;
      this.overviewChart_ = undefined;
      this.mwuResult_ = undefined;
      this.attachedPromise_ = new Promise(resolve => {
        this.resolveAttachedPromise_ = resolve;
      });
    },

    ready() {
      this.addEventListener('click', this.onClick_.bind(this));
    },

    attached() {
      this.resolveAttachedPromise_();
      if (this.row) {
        this.row.rootViewState.addUpdateListener(this.rootListener_);
      }
    },

    detached() {
      this.attachedPromise_ = new Promise(resolve => {
        this.resolveAttachedPromise_ = resolve;
      });
      this.row.rootViewState.removeUpdateListener(this.rootListener_);
      // Don't need to removeUpdateListener for the row and cells; their
      // lifetimes are the same as |this|.
    },

    isMissing_(histogram) {
      return histogram === undefined;
    },

    isEmpty_(histogram) {
      return histogram.numValues === 0;
    },

    isUnmergeable_(histogram) {
      return histogram instanceof tr.v.HistogramSet;
    },

    isValid_(histogram) {
      return histogram.numValues > 0;
    },

    updateMwu_() {
      const referenceHistogram = this.referenceHistogram;
      this.mwuResult_ = undefined;
      if (!(this.histogram instanceof tr.v.Histogram)) return;
      if (!this.histogram.canCompare(referenceHistogram)) return;
      this.mwuResult_ = tr.b.math.Statistics.mwu(
          this.histogram.sampleValues,
          referenceHistogram.sampleValues,
          this.row.rootViewState.alpha);
    },

    async build(row, displayLabel, viewState) {
      this.row_ = row;
      this.displayLabel_ = displayLabel;
      this.viewState_ = viewState;
      this.histogram = this.row.columns.get(displayLabel);

      if (this.viewState) {
        // this.viewState is undefined when this.histogram_ is undefined.
        // In that case, onViewStateUpdate_ wouldn't be able to do anything
        // anyway.
        this.viewState.addUpdateListener(this.onViewStateUpdate_.bind(this));
      }
      this.row.viewState.addUpdateListener(this.onRowStateUpdate_.bind(this));
      if (this.isAttached) {
        this.row.rootViewState.addUpdateListener(this.rootListener_);
      }

      await this.attachedPromise_;

      this.updateMwu_();

      // this.histogram_ and this.referenceHistogram might be undefined,
      // a HistogramSet of unmergeable Histograms, or a Histogram.
      this.updateContents_();
    },

    updateSignificance_() {
      if (!this.mwuResult_) return;
      this.$.scalar.significance = this.mwuResult_.significance;
    },

    get viewState() {
      return this.viewState_;
    },

    get row() {
      return this.row_;
    },

    get referenceHistogram() {
      const referenceDisplayLabel =
        this.row.rootViewState.referenceDisplayLabel;
      if (!referenceDisplayLabel) return undefined;
      if (referenceDisplayLabel === this.displayLabel_) return undefined;
      return this.row.columns.get(referenceDisplayLabel);
    },

    set isHistogramOpen(open) {
      if (!(this.histogram instanceof tr.v.Histogram) ||
          (this.histogram.numValues === 0)) {
        return;
      }

      // Unfortunately, we can't use a css attribute for this since this stuff
      // is tied up in all the possible states of this.histogram. See
      // updateContents_().

      this.$.scalar.style.display = open ? 'none' : 'flex';
      this.$.histogram.style.display = open ? 'block' : 'none';

      // Wait to create the histogram-span until the user wants to display it
      // in order to speed up creating lots of histogram-set-table-cells when
      // building the table.
      if (open && this.histogramSpan_ === undefined) {
        this.histogramSpan_ = document.createElement('tr-v-ui-histogram-span');
        this.$.histogram.appendChild(this.histogramSpan_);
        this.histogramSpan_.viewState = this.viewState;
        this.histogramSpan_.rowState = this.row.viewState;
        this.histogramSpan_.rootState = this.row.rootViewState;
        this.histogramSpan_.build(this.histogram, this.referenceHistogram);
      }

      this.viewState.isOpen = open;
    },

    onViewStateUpdate_(event) {
      if (event.delta.isOpen) {
        this.isExpanded = this.viewState.isOpen;
      }
    },

    onRowStateUpdate_(event) {
      if (event.delta.isOverviewed === undefined) return;
      if (this.row.viewState.isOverviewed) {
        this.showOverview();
      } else {
        this.hideOverview();
      }
    },

    onRootStateUpdate_(event) {
      if (event.delta.referenceDisplayLabel &&
          this.histogramSpan_) {
        this.histogramSpan_.build(this.histogram, this.referenceHistogram);
      }

      if (event.delta.displayStatisticName ||
          event.delta.referenceDisplayLabel) {
        this.updateMwu_();
        this.updateContents_();
      } else if (event.delta.alpha && this.mwuResult_) {
        this.mwuResult_.compare(this.row.rootViewState.alpha);
        this.updateSignificance_();
      }

      if (this.row.viewState.isOverviewed &&
          (event.delta.sortColumnIndex ||
           event.delta.sortDescending ||
           event.delta.displayStatisticName ||
           event.delta.referenceDisplayLabel)) {
        if (this.overviewChart_ !== undefined) {
          this.$.overview_container.removeChild(this.overviewChart_);
          this.overviewChart_ = undefined;
        }
        this.showOverview();
      }
    },

    onClick_(event) {
      // Since the histogram-set-table's table doesn't support any kind of
      // selection, clicking anywhere within a row that has subRows will
      // expand/collapse that row, which can relayout the table and move things
      // around. Prevent table relayout by preventing the tr-ui-b-table from
      // receiving the click event.
      event.stopPropagation();
    },

    toggleExpanded_(e) {
      this.isExpanded = !this.isExpanded;
      tr.b.Timing.instant('histogram-set-table-cell', this.isExpanded ?
        'open' : 'close');
    },

    toggleBisect_(e) {
      this.isBisectExpanded = !this.isBisectExpanded;
      if (this.isBisectExpanded) {
        this.isSamplesExpanded = false;
        this.isMetadataExpanded = false;
      }
    },

    toggleSamples_(e) {
      this.isSamplesExpanded = !this.isSamplesExpanded;
      if (this.isSamplesExpanded) {
        this.isBisectExpanded = false;
        this.isMetadataExpanded = false;
      }
    },

    toggleMetadata_(e) {
      this.isMetadataExpanded = !this.isMetadataExpanded;
      if (this.isMetadataExpanded) {
        this.isBisectExpanded = false;
        this.isSamplesExpanded = false;
      }
    },

    updateContents_() {
      // TODO getDeltaScalars_
      this.$.stats.scalarMap = this.histogram.statisticsScalars;
      // TODO this.$.sample_diagnostics
      // TODO this.$.metadata_diagnostics

      this.updateSignificance_();

      const referenceHistogram = this.referenceHistogram;
      const statName = this.histogram.getAvailableStatisticName(
          this.row.rootViewState.displayStatisticName, referenceHistogram);
      const statisticScalar = this.histogram.getStatisticScalar(
          statName, referenceHistogram);
      this.$.scalar.setValueAndUnit(
          statisticScalar.value, statisticScalar.unit);
    },

    showOverview() {
      this.$.overview_container.style.display = 'block';
      if (this.overviewChart_ !== undefined) return;

      this.row.sortSubRows();
      let referenceDisplayLabel =
        this.row.rootViewState.referenceDisplayLabel;
      if (referenceDisplayLabel === this.displayLabel_) {
        referenceDisplayLabel = undefined;
      }
      const displayStatisticName = this.row.rootViewState.displayStatisticName;
      const data = [];
      let unit;

      for (const subRow of this.row.subRows) {
        const subHist = subRow.columns.get(this.displayLabel_);
        if (!(subHist instanceof tr.v.Histogram)) continue;

        if (unit === undefined) {
          unit = subHist.unit;
        } else if (unit !== subHist.unit) {
          // The subrows have different units, so the overview chart cannot
          // use a single unit to format all of the values, so don't display
          // an overview chart at all.
          data.splice(0);
          break;
        }

        const refHist = subRow.columns.get(referenceDisplayLabel);
        const statName = subHist.getAvailableStatisticName(
            displayStatisticName, refHist);
        const statScalar = subHist.getStatisticScalar(
            statName, refHist);

        if (statScalar !== undefined) {
          data.push({
            x: subRow.name,
            y: statScalar.value,
          });
        }
      }
      if (data.length < 2) return;

      this.overviewChart_ = new tr.ui.b.NameLineChart();
      this.$.overview_container.appendChild(this.overviewChart_);
      this.overviewChart_.displayXInHover = true;
      this.overviewChart_.hideLegend = true;
      this.overviewChart_.unit = unit;
      this.overviewChart_.overrideDataRange = this.row.overviewDataRange;
      this.overviewChart_.data = data;
    },

    hideOverview() {
      this.$.overview_container.style.display = 'none';
    }
  });

  return {
  };
});
</script>
