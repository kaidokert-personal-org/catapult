<!DOCTYPE html>
<!--
Copyright 2017 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="/tracing/base/timing.html">
<link rel="import" href="/tracing/ui/base/dom_helpers.html">
<link rel="import" href="/tracing/ui/base/grouping_table_groupby_picker.html">
<link rel="import" href="/tracing/value/ui/histogram_set_view_state.html">

<dom-module id="tr-v-ui-histogram-set-controls-overviews">
  <template>
    <button on-tap="onTap_" id="button"></button>
  </template>
</dom-module>

<script>
'use strict';
tr.exportTo('tr.v.ui', function() {
  Polymer({
    is: 'tr-v-ui-histogram-set-controls-overviews',

    created() {
      this.viewState_ = undefined;
      this.rowListener_ = this.onRowViewStateUpdate_.bind(this);
      this.anyOverviews_ = false;
    },

    get viewState() {
      return this.viewState_;
    },

    /**
     * @param {!tr.v.ui.HistogramSetViewState} viewState
     * @param {!tr.v.HistogramSetSynopsis} synopsis
     */
    build(viewState, synopsis) {
      this.viewState_ = viewState;
      this.viewState.addUpdateListener(this.onViewStateUpdate_.bind(this));
      this.updateContents_();
    },

    onViewStateUpdate_(event) {
      if (event.delta.tableRowStates) {
        for (const rowState of tr.v.ui.HistogramSetTableRowState.walkAll(
            this.viewState.tableRowStates.values())) {
          rowState.addUpdateListener(this.rowListener_);
        }
        this.updateContents_();
      }
    },

    onRowViewStateUpdate_(event) {
      if (event.delta.isOverviewed) {
        this.updateContents_();
      }
    },

    updateContents_() {
      this.anyOverviews_ = false;
      for (const rowState of tr.v.ui.HistogramSetTableRowState.walkAll(
          this.viewState.tableRowStates.values())) {
        if (rowState.isOverviewed) {
          this.anyOverviews_ = true;
          break;
        }
      }

      this.$.button.textContent = (
          this.anyOverviews_ ? 'Hide' : 'Show') + ' All Overview Charts';
    },

    async onTap_() {
      for (const rowState of tr.v.ui.HistogramSetTableRowState.walkAll(
          this.viewState.tableRowStates.values())) {
        await rowState.update({isOverviewed: !this.anyOverviews_});
      }
    }
  });

  return {
  };
});
</script>
