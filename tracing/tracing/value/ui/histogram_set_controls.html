<!DOCTYPE html>
<!--
Copyright 2017 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="/tracing/base/timing.html">
<link rel="import" href="/tracing/ui/base/dom_helpers.html">
<link rel="import" href="/tracing/value/ui/dropdown.html">
<link rel="import" href="/tracing/value/ui/histogram_set_controls_compare.html">
<link rel="import" href="/tracing/value/ui/histogram_set_controls_export.html">
<link rel="import" href="/tracing/value/ui/histogram_set_controls_overviews.html">
<link rel="import" href="/tracing/value/ui/histogram_set_controls_pivot.html">
<link rel="import" href="/tracing/value/ui/histogram_set_controls_statistics.html">
<link rel="import" href="/tracing/value/ui/histogram_set_view_state.html">

<dom-module id="tr-v-ui-histogram-set-controls">
  <template>
    <style>
    menu {
      white-space: nowrap;
      margin: 0;
      padding: 0;
      background-color: #eee;
    }

    #search {
      border: 0;
      margin-bottom: 5px;
      margin-left: 5px;
      max-width: 20em;
      outline: 0;
      padding-left: 5px;
    }

    #search:focus {
      border-bottom: 2px solid black;
      margin-bottom: 3px;
    }

    #show_all, tr-v-ui-dropdown, #help {
      margin-left: 1em;
    }

    tr-v-ui-dropdown {
      --dropdown-button: {
        -webkit-appearance: none;
        background-color: #eee;
        border: 0;
        cursor: pointer;
        font-size: initial;
        padding: 5px 0;
      };
      --dropdown-button-open: {
        border-bottom: 2px solid black;
      }
    }

    .dialog_container {
      display: grid;
      grid-gap: 1em;
    }

    #help {
      display: none;
    }
    </style>

    <menu>
      <input id="search" placeholder="Find Histogram name"
        on-keyup="onSearchKeyup_">

      <input type="checkbox" id="show_all" on-change="onShowAllChange_"
        title="When unchecked, less important histograms are hidden.">
      <label for="show_all" title="When unchecked, less important histograms are hidden.">Show all</label>

      <tr-v-ui-dropdown id="pivot" label="Pivot">
        <div class="dialog_container">
          <tr-v-ui-histogram-set-controls-overviews>
          </tr-v-ui-histogram-set-controls-overviews>
          <tr-v-ui-histogram-set-controls-pivot>
          </tr-v-ui-histogram-set-controls-pivot>
        </div>
      </tr-v-ui-dropdown>

      <tr-v-ui-dropdown id="compare" label="Compare">
        <tr-v-ui-histogram-set-controls-compare>
        </tr-v-ui-histogram-set-controls-compare>
      </tr-v-ui-dropdown>

      <tr-v-ui-dropdown id="statistics" label="Statistics">
        <tr-v-ui-histogram-set-controls-statistics>
        </tr-v-ui-histogram-set-controls-statistics>
      </tr-v-ui-dropdown>

      <tr-v-ui-dropdown id="export" label="Export">
        <tr-v-ui-histogram-set-controls-export>
        </tr-v-ui-histogram-set-controls-export>
      </tr-v-ui-dropdown>

      <a id="help">Help</a>
    </menu>
  </template>
</dom-module>

<script>
'use strict';
tr.exportTo('tr.v.ui', function() {
  Polymer({
    is: 'tr-v-ui-histogram-set-controls',

    /**
     * @param {!tr.v.ui.HistogramSetViewState} viewState
     * @param {!tr.v.HistogramSetSynopsis} synopsis
     * @param {!Object=} opt_options
     * @param {string} opt_options.helpHref
     * @param {boolean} opt_options.disableShowAll
     */
    build(viewState, synopsis, opt_options) {
      const options = opt_options || {};

      if (this.viewState_) {
        throw new Error('viewState must be set exactly once.');
      }
      this.viewState_ = viewState;
      this.viewState.addUpdateListener(this.onViewStateUpdate_.bind(this));
      // It would be arduous to construct a delta and call viewStateListener_
      // here in case viewState contains non-default values, so callers must set
      // viewState first and then update it.

      const needsBuilding = [].concat(
          Array.from(this.$.pivot.children[0].children),
          Array.from(this.$.compare.children),
          Array.from(this.$.statistics.children));
      for (const elem of needsBuilding) {
        elem.build(viewState, synopsis, options);
      }

      this.$.show_all.checked = (
          options.disableShowAll || this.viewState.showAll);
      this.$.show_all.disabled = options.disableShowAll;

      if (options.helpHref) {
        this.$.help.href = options.helpHref;
        this.$.help.style.display = 'inline';
      }

      if (options.hotkeyTarget) {
        options.hotkeyTarget.addEventListener('keyup',
            this.onHotKeyup_.bind(this));
      }
    },

    get viewState() {
      return this.viewState_;
    },

    async onSearchKeyup_(event) {
      event.stopPropagation();
      if (event.key === 'Escape') {
        this.$.search.blur();
        return;
      }
      const mark = tr.b.Timing.mark('histogram-set-controls', 'search');
      await this.viewState_.update({searchQuery: this.$.search.value});
      mark.end();
    },

    async onShowAllChange_() {
      const mark = tr.b.Timing.mark('histogram-set-controls', 'showAll');
      await this.viewState_.update({showAll: this.$.show_all.checked});
      mark.end();
    },

    onViewStateUpdate_(event) {
      if (event.delta.searchQuery) {
        this.$.search.value = this.viewState.searchQuery;
      }

      if (event.delta.showAll) this.$.show_all.checked = this.viewState.showAll;
    },

    onHotKeyup_(event) {
      switch (event.key) {
        case '/':
          this.$.search.focus();
          break;
        case 'A':
          this.$.show_all.checked = !this.$.show_all.checked;
          this.onShowAllChange_();
          break;
        case 'p':
          this.$.pivot.open();
          break;
        case 'c':
          this.$.compare.open();
          break;
        case 's':
          this.$.statistics.open();
          break;
        case 'e':
          this.$.export.open();
          break;
      }
    },
  });

  return {
  };
});
</script>
