<!DOCTYPE html>
<!--
Copyright 2015 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="/tracing/base/unit.html">
<link rel="import" href="/tracing/base/unit_scale.html">
<link rel="import" href="/tracing/base/utils.html">
<link rel="import" href="/tracing/model/event_set.html">
<link rel="import" href="/tracing/ui/base/table.html">

<dom-module id='tr-ui-a-power-sample-summary-table'>
  <template>
    <style>
    tr-ui-b-table {
      font-size: 12px;
    }
    </style>
    <tr-ui-b-table id="table"></tr-ui-b-table>
  </template>
</dom-module>
<script>
'use strict';

Polymer({
  is: 'tr-ui-a-power-sample-summary-table',

  ready() {
    this.$.table.tableColumns = [
      {
        title: 'Sample',
        width: '120px',
        value(row) {
          return row.type;
        }
      },
      {
        title: 'Min power',
        width: '100px',
        value(row) {
          return tr.b.Unit.byName.powerInWatts.format(row.min);
        }
      },
      {
        title: 'Max power',
        width: '100px',
        value(row) {
          return tr.b.Unit.byName.powerInWatts.format(row.max);
        }
      },
      {
        title: 'Time-weighted average',
        width: '100px',
        value(row) {
          return tr.b.Unit.byName.powerInWatts.format(
              row.timeWeightedAverageInW);
        }
      },
      {
        title: 'Energy consumed',
        width: '100px',
        value(row) {
          return tr.b.Unit.byName.energyInJoules.format(row.energyConsumedInJ);
        }
      },
      {
        title: 'Sample count',
        width: '100%',
        value(row) { return row.sampleCount; }
      }
    ];
    this.samples = {};
  },

  get samples() {
    return this.samples_;
  },

  set samples(samples) {
    if (samples === this.samples) return;

    this.samples_ = (samples === undefined) ? {} : samples;
    this.updateContents_();
  },

  updateContents_() {
    this.$.table.tableRows = [];
    for (const type of Object.keys(this.samples)) {
      if (this.samples[type].length === 0) {
        continue;
      }
      this.$.table.tableRows.push({
        type: type,
        min: this.getMin(type),
        max: this.getMax(type),
        timeWeightedAverageInW: this.getTimeWeightedAverageInW(type),
        energyConsumedInJ: this.getEnergyConsumedInJ(type),
        sampleCount: this.samples[type].length
      });
    }

    this.$.table.rebuild();
  },

  getMin(type) {
    return Math.min.apply(null, this.samples[type].map(function(sample) {
      return sample.powerInW;
    }));
  },

  getMax(type) {
    return Math.max.apply(null, this.samples[type].map(function(sample) {
      return sample.powerInW;
    }));
  },

  /**
   * Returns a time-weighted average of the power consumption (Watts)
   * in between the first sample (inclusive) and last sample (exclusive).
   */
  getTimeWeightedAverageInW(type) {
    const energyConsumedInJ = this.getEnergyConsumedInJ(type);

    if (energyConsumedInJ === 'N/A') return 'N/A';

    const durationInS = tr.b.convertUnit(this.samples[type].bounds.duration,
        tr.b.UnitPrefixScale.METRIC.MILLI,
        tr.b.UnitPrefixScale.METRIC.NONE);

    return energyConsumedInJ / durationInS;
  },

  getEnergyConsumedInJ(type) {
    if (this.samples[type].length < 2) return 'N/A';

    const bounds = this.samples[type].bounds;
    const series = tr.b.getFirstElement(this.samples[type]).series;
    return series.getEnergyConsumedInJ(bounds.min, bounds.max);
  }
});
</script>
