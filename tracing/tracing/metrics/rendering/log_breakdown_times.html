<!DOCTYPE html>
<!--
Copyright 2018 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->
<link rel="import" href="/tracing/base/math/statistics.html">
<link rel="import" href="/tracing/base/unit.html">
<link rel="import" href="/tracing/base/unit_scale.html">
<link rel="import" href="/tracing/metrics/rendering/cpu_utilization.html">
<link rel="import" href="/tracing/model/helpers/chrome_model_helper.html">
<link rel="import" href="/tracing/model/user_model/segment.html">
<link rel="import" href="/tracing/value/diagnostics/generic_set.html">
<link rel="import" href="/tracing/value/diagnostics/related_event_set.html">
<link rel="import" href="/tracing/value/histogram.html">

<script>
    'use strict';
    tr.exportTo('tr.metrics.rendering', function() {
      function addBreakdownTimes(histograms, model, segments) {
        const chromeHelper = model.getOrCreateHelper(
            tr.model.helpers.ChromeModelHelper);

        let total_pipeline_reporters = 0;
        let total_main_thread_animation_pipeline_reporters = 0;
        let total_compositor_thread_animation_pipeline_reporters = 0;
        let total_main_thread_scroll_pipeline_reporters = 0;
        let total_compositor_thread_scroll_pipeline_reporters = 0;
        let total_pipeline_reporters_with_any_interaction = 0;

        for (const rendererHelper of Object.values(chromeHelper.rendererHelpers)) {
          let pipeline_reporters = [];

          let all_slices = [];
          let Last_PR;

          if (rendererHelper.compositorThread === undefined) continue;
          const slices = rendererHelper.compositorThread.asyncSliceGroup.slices;
          for (const slice of slices) {            
            if (slice.title !== 'PipelineReporter') continue;
            pipeline_reporters.push(slice);
          }

          pipeline_reporters.sort(function (a, b) {
            if (a.start == b.start) return (a.duration - b.duration);
            return (a.start - b.start);
          });
        
          var num_complete_pipeline_reporters = 0;
          var complete_pipeline_reporters = [];
          for (const pr of pipeline_reporters) {
            total_pipeline_reporters += 1;
            let has_interaction = false;
            let CFR = pr.args.chrome_frame_reporter;
            let stages = [];
            pr.subSlices.forEach(function (item, index) {
            stages.push(item.title);
            });
            
            if (stages.includes('BeginImplFrameToSendBeginMainFrame') && (stages.includes('EndActivateToSubmitCompositorFrame')) && (stages.includes('SubmitCompositorFrameToPresentationCompositorFrame'))) {
                complete_pipeline_reporters.push(pr);
                num_complete_pipeline_reporters += 1;
            }
          }
          console.log(num_complete_pipeline_reporters);
      }

      return {
        addBreakdownTimes,
      };
    });
</script>