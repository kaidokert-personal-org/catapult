<!DOCTYPE html>
<!--
Copyright 2019 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="/tracing/metrics/metric_registry.html">
<link rel="import" href="/tracing/metrics/old_uma_metric.html">
<link rel="import" href="/tracing/value/histogram.html">
<link rel="import" href="/tracing/value/histogram_set.html">

<script>
'use strict';

tr.exportTo('tr.metrics', function() {
  /**
   * This metric is a limited version of new CPU Time metric. The new cpu time
   * metric produces 300-500 histograms for a trace, which is overwhelming for
   * some systems. This file exposes a subset of those histograms.
   *
   * TODO(#4044): Remove this metric once histogram pipeline is ready.
   *
   * @param {!tr.v.HistogramSet} histograms
   * @param {!tr.model.Model} model
   */
  function umaMetric(histograms, model, opt_options) {
    const umaHistograms = new tr.v.HistogramSet();
    tr.metrics.oldUmaMetric(umaHistograms, model);

    const functionsToApply = [
      { suffix: 'avg', property: 'average' },
      { suffix: 'sum', property: 'sum' },
      { suffix: 'count', property: 'numValues' }
    ];

    for (const histo of umaHistograms) {
      for (const functionToApply of functionsToApply) {
        const histogram = new tr.v.Histogram(
            histo.name + '_' + functionToApply.suffix,
            histo.unit,
            tr.v.HistogramBinBoundaries.fromDict(histo.binBoundariesDict_)
        );
        histogram.addSample(histo[functionToApply.property]);
        histograms.addHistogram(histogram);
      }
    }
  }

  tr.metrics.MetricRegistry.register(umaMetric, {
    requiredCategories: ['benchmark'],
  });

  return {
    umaMetric,
  };
});
</script>
