<!DOCTYPE html>
<!--
Copyright 2018 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="/tracing/metrics/metric_registry.html">

<script>
'use strict';

tr.exportTo('tr.metrics.tabs', function() {
  function tabsMetric(histograms, model, opt_options) {
    const chromeHelper = model.getOrCreateHelper(
        tr.model.helpers.ChromeModelHelper);
    if (!chromeHelper) {
      // Chrome isn't present.
      return;
    }
    const tabSwitchLatencies = [];
    const TAB_SWITCHING_SLICE_TITLE = 'TabSwitching::Latency';

    function extractLatencyFromHelpers(helpers) {
      for (const helper of helpers) {
        if (!helper.mainThread) {
          continue;
        }
        const thread = helper.mainThread;
        for (const slice of thread.sliceGroup.slices) {
          if (slice.title === TAB_SWITCHING_SLICE_TITLE) {
            tabSwitchLatencies.push(slice.args.latency);
          }
        }
      }
    }

    // First, get the latency metrics from the sync slices in the browser and
    // the renderer processes.
    extractLatencyFromHelpers(chromeHelper.browserHelpers);
    extractLatencyFromHelpers(Object.values(chromeHelper.rendererHelpers));

    // Fallback to the async slices for legacy measurements.
    if (tabSwitchLatencies.length === 0) {
      for (const helper of chromeHelper.browserHelpers) {
        if (!helper.mainThread) {
          continue;
        }
        const thread = helper.mainThread;
        for (const slice of thread.asyncSliceGroup.slices) {
          if (slice.title === TAB_SWITCHING_SLICE_TITLE) {
            tabSwitchLatencies.push(slice.duration);
          }
        }
      }
    }

    histograms.createHistogram('tab_switching_latency',
        tr.b.Unit.byName.timeDurationInMs_smallerIsBetter,
        tabSwitchLatencies, { description: 'Tab switching time in ms',
          summaryOptions: {sum: false}});
  }

  tr.metrics.MetricRegistry.register(tabsMetric, {
    supportsRangeOfInterest: false,
  });

  return {
    tabsMetric,
  };
});
</script>
