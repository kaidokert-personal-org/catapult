<!DOCTYPE html>
<!--
Copyright (c) 2012 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="/tracing/extras/importer/linux_perf/parser.html">

<script>
'use strict';

/**
 * @fileoverview Parses gpu_util events in the Linux event trace format.
 */
tr.exportTo('tr.e.importer.linux_perf', function() {
  const ColorScheme = tr.b.ColorScheme;
  const Parser = tr.e.importer.linux_perf.Parser;

  /**
   * Parses linux gpu_util trace events.
   * @constructor
   */
  function GpuUtilParser(importer) {
    Parser.call(this, importer);

    importer.registerEventHandler('gpu_util',
        GpuUtilParser.prototype.gpuUtilUpDownEvent.bind(this));
  }

  function splitData(input) {
    const data = {};
    const args = input.split('=');
    data[args[0]] = parseInt(args[1]);
    return data;
  }

  GpuUtilParser.prototype = {
    __proto__: Parser.prototype,

    gpuutilSlice(ts, eventName, args) {
      const kthread = this.importer.getOrCreatePseudoThread('gpu_util');
      kthread.openSlice = eventName;
      const slice = new tr.model.ThreadSlice('', kthread.openSlice,
          ColorScheme.getColorIdForGeneralPurposeString(kthread.openSlice),
          ts, args, 0);

      kthread.thread.sliceGroup.pushSlice(slice);
    },


    /**
     * Parses gpu_util events and sets up state in the importer.
     */
    gpuUtilUpDownEvent(eventName, cpuNumber, pid, ts, eventBase) {
      const data = splitData(eventBase.details);
      this.gpuutilSlice(ts, eventName, data);
      return true;
    },

  };

  Parser.register(GpuUtilParser);

  return {
    GpuUtilParser,
  };
});
</script>

