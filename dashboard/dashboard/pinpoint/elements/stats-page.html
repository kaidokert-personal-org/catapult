<!DOCTYPE html>
<!--
Copyright 2018 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="/elements/base-style.html">
<link rel="import" href="/elements/loading-wrapper.html">


<dom-module id="stats-table">
  <template>
    <style include="base-style">
      th {
        background-position: right 0.5em center;
        background-repeat: no-repeat;
        background-size: 0.8em;
        border-bottom: solid 1px var(--paper-grey-400);
        cursor: pointer;
      }

      th:hover {
        color: var(--paper-pink-a200);
      }

      th[data-sort-direction=true] {
        background-image: url("/static/sort-up.svg");
      }

      th[data-sort-direction=false] {
        background-image: url("/static/sort-down.svg");
      }

      td {
        word-break: break-all;
      }
    </style>

    <table id="jobs">
      <thead>
        <tr>
          <th id="job_id" on-click="columnHeaderClicked">Job ID
          <th id="bug_id" on-click="columnHeaderClicked">Bug #
          <th id="status" on-click="columnHeaderClicked">Status
          <th id="differences" on-click="columnHeaderClicked">Differences
          <th id="created" on-click="columnHeaderClicked">Created
          <th id="configuration" on-click="columnHeaderClicked">Configuration
          <th id="benchmark" on-click="columnHeaderClicked">Benchmark
      <tbody>
        <template is="dom-repeat" items="[[jobs]]" sort="[[jobSorter(sortBy, sortDescending)]]">
          <tr>
            <td><a href='/job/[[item.job_id]]'>[[item.job_id]]</a>
            <td><a href='http://crbug.com/[[item.bug_id]]'>[[item.bug_id]]</a>
            <td>[[item.status]]
            <td>[[item.differences]]
            <td>[[formatDate(item.created)]]
            <td>[[item.arguments.configuration]]
            <td>[[item.arguments.benchmark]]
        </template>
    </table>
  </template>

  <script>
    'use strict';
    Polymer({
      is: 'stats-table',

      properties: {
        jobs: {
          type: Array,
          value: () => []
        },

        /**
         * The field to sort by. Note that this will be both the id of a th
         * element in the table, and a property of an item in the job list.
         */
        sortBy: {
          type: String,
          value: 'created'
        },

        /**
         * Sort direction, either 'down' (increasing) or 'up' (decreasing).
         */
        sortDescending: {
          type: Boolean,
          value: true
        },
      },

      /**
       * Custom element lifecycle callback, called once this element is ready.
       */
      ready() {
        this.updateHeaders();
      },

      /**
       * Callback for the click event for a column header.
       * @param {Event} event Clicked event.
       * @param {Object} detail Detail Object.
       */
      columnHeaderClicked(event, detail) {
        if (this.sortBy == event.currentTarget.id) {
          this.sortDescending = !this.sortDescending;
        } else {
          this.sortBy = event.currentTarget.id;
          this.sortDescending = false;
        }
        this.updateHeaders();
      },

      /**
       * Update the table headers to indicate the current table sorting.
       */
      updateHeaders() {
        const headers = Polymer.dom(this.$.jobs).querySelectorAll('th');
        for (let i = 0; i < headers.length; i++) {
          if (headers[i].id == this.sortBy) {
            Polymer.dom(headers[i]).setAttribute('data-sort-direction',
                this.sortDescending);
          } else {
            Polymer.dom(headers[i]).removeAttribute('data-sort-direction');
          }
        }
      },

      /**
       * Sorts the jobs list according to the current values of the properties
       * sortDirection and sortBy.
       */
      jobSorter(sortBy, sortDescending) {
        return (a, b) => {
          const valA = (a[sortBy] || a.arguments[sortBy] || '').toString();
          const valB = (b[sortBy] || b.arguments[sortBy] || '').toString();
          let comparison = valA.localeCompare(valB);
          if (sortDescending) {
            comparison = -comparison;
          }
          return comparison;
        };
      },

      formatState(job) {
        if (job.status == 'Completed') {
          if (job.differences > 0) {
            return 'Repro';
          }
          return 'No Repro';
        } else if (job.status == 'Failed') {
          return 'Failed';
        }
        return '';
      },

      formatDate(dateString) {
        return new Date(dateString + 'Z').toLocaleString();
      }
    });
  </script>
</dom-module>


<dom-module id="stats-summary">
  <template>
    <style include="base-style">
    #stats {
      width: 500px;
    }

    tr, td {
      text-align: center;
    }
    </style>

    <h1>Quick Summary</h1>
    <table id="stats">
      <thead>
        <tr>
          <th># Jobs last 7 days
          <th>Repro'd
          <th>No Repro
          <th>Failures
      <tbody>
          <tr>
            <td>[[numCompletedJobs(jobs)]]
            <td>[[calculateRepro(jobs)]]
            <td>[[calculateNoRepro(jobs)]]
            <td>[[calculateFailure(jobs)]]
        </template>
    </table>
  </template>

  <script>
    'use strict';
    Polymer({
      is: 'stats-summary',

      properties: {
        jobs: {
          type: Object,
        },
      },

      last7Days(job, now) {
        const created = new Date(job.created + 'Z');
        const elapsedMS = now - created;

        return (elapsedMS <= 7 * 24 * 60 * 60 * 1000);
      },

      filter7Days(jobs) {
        const recentJobs = [];

        const now = Date.now();

        for (const j of jobs) {
          if (this.last7Days(j, now)) {
            recentJobs.push(j);
          }
        }

        return recentJobs;
      },

      numCompletedJobs(jobs) {
        jobs = this.filter7Days(jobs);

        let num = 0;

        for (const j of jobs) {
          if (j.status != 'Running') {
            num += 1;
          }
        }
        return num;
      },

      formatPercent(num, total) {
        const percent = num / total;
        return num + ' (' + (100.0 * percent).toFixed(1) + '%)';
      },

      calculateRepro(jobs) {
        jobs = this.filter7Days(jobs);

        let repro = 0;

        for (const j of jobs) {
          if (j.status != 'Completed') {
            continue;
          }

          if (j.differences > 0) {
            repro += 1;
          }
        }
        return this.formatPercent(repro, this.numCompletedJobs(jobs));
      },

      calculateNoRepro(jobs) {
        jobs = this.filter7Days(jobs);

        let repro = 0;

        for (const j of jobs) {
          if (j.status != 'Completed') {
            continue;
          }

          if (j.differences == 0) {
            repro += 1;
          }
        }
        return this.formatPercent(repro, this.numCompletedJobs(jobs));
      },

      calculateFailure(jobs) {
        jobs = this.filter7Days(jobs);

        let repro = 0;

        for (const j of jobs) {
          if (j.status == 'Failed') {
            repro += 1;
          }
        }
        return this.formatPercent(repro, this.numCompletedJobs(jobs));
      }
    });
  </script>
</dom-module>


<dom-module id="stats-page">
  <template>
    <style include="base-style"></style>

    <h1>Stats</h1>
    <loading-wrapper url="/api/stats" response="{{jobs}}">
      <stats-summary jobs="[[jobs]]"></stats-summary>
      <stats-table id="jobs-table"
          jobs="[[jobs]]"
          sort-by="[[queryParams.sortBy]]"
          sort-descending="[[queryParams.sortDescending]]">
      </stats-table>
    </loading-wrapper>
  </template>

  <script>
    'use strict';
    Polymer({
      is: 'stats-page',

      properties: {
        jobs: {
          type: Object,
        },
      },
    });
  </script>
</dom-module>
