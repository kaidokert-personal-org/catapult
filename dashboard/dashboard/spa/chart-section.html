<!DOCTYPE html>
<!--
Copyright 2017 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="/bower_components/iron-pages/iron-pages.html">
<link rel="import" href="/bower_components/neon-animation/neon-animations.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="/dashboard/spa/chart-placeholder.html">
<link rel="import" href="/dashboard/spa/line-chart.html">
<link rel="import" href="/dashboard/spa/test-path-component.html">
<link rel="import" href="/tracing/value/ui/histogram_set_view.html">

<dom-module id="chart-section">
  <template>
    <style>
      #controls {
        display: flex;
        margin-bottom: 8px;
      }

      #controls_inner {
        display: flex;
        flex-direction: column;
      }

      .only_chart {
        transition: max-height var(--transition-long), max-width var(--transition-long);
        overflow: hidden;
      }

      .only_chart[hiddenVertically] {
        max-height: 0 !important;
      }

      .only_chart[hiddenHorizontally] {
        max-width: 0 !important;
      }

      #test_path {
        max-height: 88px;
        display: flex;
      }

      test-path-component {
        margin-right: 8px;
      }

      paper-spinner {
        flex-shrink: 0;
        margin: auto;
        opacity: 0;
        transition: opacity var(--transition-short);
      }

      paper-spinner[active] {
        opacity: 1;
        visibility: visible;
      }

      #title {
        flex-grow: 1;
        max-height: 62px;
        --paper-input-container: {
          padding: 0;
        }
      }

      #spacer {
        flex-grow: 1;
      }

      #minimap, #chart {
        width: 100%;
      }

      #minimap {
        max-height: 75px;
      }

      #toggle_chart_only {
        display: block;
        flex-grow: 0;
        flex-shrink: 0;
        margin: 0;
        min-width: 0;
        padding: 8px;
      }

      #close {
        flex-shrink: 0;
      }

      #chart_container {
        display: flex;
        flex-wrap: wrap;
      }

      #chart_inner {
        min-width: 500px;
        flex-grow: 1;
        margin-right: 8px;
      }

      #placeholder_container {
        height: 290px;
      }

      /* TODO use CSS transitions to roll the placeholder under the chart? */

      #histograms {
        flex-shrink: 0;
        max-height: 290px;
        max-width: 1000px;
        overflow-y: auto;
      }

      #related_tabs {
        max-height: 352px;
      }

      #related_tabstrip {
        color: white;
        display: flex;
        margin-top: 8px;
        background: var(--paper-indigo-500);
        align-items: center;
        padding-left: 8px;
      }

      #related_tabstrip paper-tabs {
        flex-grow: 1;
        text-align: left;
        margin-left: 8px;
        height: 2em;
        --paper-tabs-selection-bar-color: var(--paper-indigo-200);
      }

      #related_tabstrip paper-tab {
        flex-grow: 0;
      }

      #related_tabstrip paper-tab:last-of-type {
        flex-grow: 1;
        --paper-tab-content: {
          justify-content: flex-end;
        }
      }

      .related_tab {
        display: flex;
        flex-wrap: wrap;
        max-height: 0;
        overflow: hidden;
        transition: max-height var(--transition-long);
      }

      .related_tab[selected] {
        max-height: 324px;
      }

      .sparkline_tile {
        cursor: pointer;
        width: 200px;
        margin: 0.25em;
        background: rgba(0, 0, 0, 0.05);
        margin: 5px;
      }

      .sparkline_name {
        padding: 16px;
      }

      #documentation {
        color: var(--paper-indigo-500);
        margin: auto;
      }

      #options {
        background: var(--paper-indigo-500);
        border-radius: 3px;
        color: white;
        height: 30px;
        max-height: 30px;
        padding: 0;
      }

      #options_container {
        display: inline-block;
        position: absolute;
        margin-top: 15px;
      }

      paper-dialog {
        margin: 0;
      }
    </style>

    <div id="controls">
      <div id="controls_inner">
        <div id="test_path"
            class="only_chart"
            hiddenVertically$="[[onlyChart]]">
          <template is="dom-repeat" items="[[testPathComponents]]">
            <test-path-component section-id="[[sectionId]]"
                                component-index="[[index]]">
            </test-path-component>
          </template>

          <paper-spinner active$="[[isLoading]]">
          </paper-spinner>

          <a id="documentation"
            href="#"
            target="_blank"
            title="Documentation">
            <paper-icon-button icon="help"></paper-icon-button>
          </a>
        </div>

        <paper-input id="title"
                    value="[[title]]"
                    label="Title"
                    class="only_chart"
                    hiddenVertically$="[[!onlyChart]]"
                    on-keyup="onTitleKeyup_">
        </paper-input>
      </div>

      <span id="spacer">&nbsp;</span>

      <paper-button id="toggle_chart_only"
                    on-tap="toggleChartOnly_">
        <template is="dom-if" if="[[onlyChart]]">
          <iron-icon icon="expand-more">
          </iron-icon>
        </template>
        <template is="dom-if" if="[[!onlyChart]]">
          <iron-icon icon="expand-less">
          </iron-icon>
        </template>
      </paper-button>

      <paper-icon-button id="close"
                         icon="close"
                         on-tap="closeSection_">
      </paper-icon-button>
    </div>

    <div id="chart_container">
      <div id="chart_inner">
        <template is="dom-if" if="[[chartLayout]]">
          <span id="options_container">
            <paper-icon-button id="options"
                               icon="more-vert"
                               class="only_chart"
                               hiddenVertically$="[[onlyChart]]"
                               style$="width: calc([[chartLayout.yAxisWidth]]px - 8px);"
                               on-tap="toggleOptions_">
            </paper-icon-button>
            <paper-dialog opened="[[isShowingOptions]]"
                          horizontal-align="left"
                          vertical-align="top"
                          entry-animation="slide-from-left-animation"
                          exit-animation="slide-left-animation"
                          on-iron-overlay-canceled="toggleOptions_">
              <paper-toggle-button>
                Normalize
              </paper-toggle-button>
              <paper-toggle-button>
                Zero Y-Axis
              </paper-toggle-button>
              <paper-toggle-button>
                Fixed X-Axis
              </paper-toggle-button>
            </paper-dialog>
          </span>

          <line-chart id="minimap"
                      class="only_chart"
                      hiddenVertically$="[[onlyChart]]"
                      layout="[[minimapLayout]]"
                      on-brush-handle-down="onMinimapBrushHandleDown_"
                      on-brush-handle-move="onMinimapBrushHandleMove_"
                      on-brush-handle-up="onMinimapBrushHandleUp_">
          </line-chart>

          <line-chart id="chart"
                      layout="[[chartLayout]]"
                      on-dot-click="onDotClick_"
                      on-dot-mouseover="onDotMouseOver_"
                      on-dot-mouseout="onDotMouseOut_"
                      on-brush-handle-down="onBrushHandleDown_"
                      on-brush-handle-move="onBrushHandleMove_"
                      on-brush-handle-up="onBrushHandleUp_">
          </line-chart>
        </template>

        <template is="dom-if" if="[[!chartLayout]]">
          <div id="placeholder_container">
            <chart-placeholder/>
          </div>
        </template>
      </div>

      <template is="dom-if" if="[[!_empty(histograms)]]">
        <tr-v-ui-histogram-set-view id="histograms"
                                    show-controls="[[showHistogramsControls]]"
                                    expand-all-rows
                                    histograms="[[histograms]]"
                                    class="only_chart"
                                    hiddenHorizontally$="[[onlyChart]]">
        </tr-v-ui-histogram-set-view>
      </template>
    </div>

    <div id="related_tabs"
         class="only_chart"
         hiddenVertically$="[[onlyChart]]">
      <template is="dom-if" if="[[!_empty(relatedTabs)]]">
        <div id="related_tabstrip">
          <div>Related</div>
          <paper-tabs selected="[[selectedRelatedTabIndex]]"
                      on-iron-select="onSelectRelatedTab_"
                      on-iron-deselect="onSelectRelatedTab_">
            <template is="dom-repeat" items="[[relatedTabs]]" as="tab">
              <paper-tab>[[tab.name]]</paper-tab>
            </template>

            <paper-tab id="close_related_tab">
              &mdash;
            </paper-tab>
          </paper-tabs>
        </div>

        <!-- iron-pages disallows CSS transitions -->
        <template is="dom-repeat" items="[[relatedTabs]]" as="tab" index-as="tabIndex">
          <div class="related_tab"
               selected$="[[_eq(tabIndex, selectedRelatedTabIndex)]]">
            <template is="dom-repeat" items="[[tab.sparklines]]" as="sparkline">
              <div class="sparkline_tile"
                  on-tap="onSparklineTap_">
                <line-chart class="sparkline"
                            layout="[[sparkline.layout]]">
                </line-chart>
                <div class="sparkline_name">[[sparkline.name]]</div>
              </div>
            </template>
          </div>
        </template>
      </template>
    </div>
  </template>
</dom-module>

<script src="/dashboard/spa/chart-section.js"></script>
