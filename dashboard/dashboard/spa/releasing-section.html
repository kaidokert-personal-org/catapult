<!DOCTYPE html>
<!--
Copyright 2017 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="/bower_components/paper-styles/element-styles/paper-material-styles.html">
<link rel="import" href="/tracing/value/ui/histogram_set_table.html">
<script src="/dashboard/spa/releasing-section-actions.js"></script>
<script src="/dashboard/spa/releasing-section-reducers.js"></script>

<dom-module id="releasing-section">
  <template>
    <style include="paper-material-styles">
      #controls {
        display: flex;
      }

      #milestones{
        align-items: center;
        display: flex;
        flex-grow: 1;
        justify-content: center;
        margin: auto 0;
        font-size: large;
      }

      #milestones paper-button {
        padding: 0;
        margin: 0 1em;
        @apply --paper-material-elevation-1;
      }

      #tables {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-evenly;
      }

      #tables div {
        margin: 0.5em;
      }

      table {
        border-collapse: collapse;
      }

      table thead th,
      th[even-category] {
        background-color: #e8eaf6;
      }

      h2 {
        text-align: center;
      }

      .name_column {
        text-align: left;
      }

      tr:nth-child(even) {
        background: rgba(232, 234, 246, 0.5);
      }

      td, th {
        padding: 4px;
      }
    </style>

    <div id="controls">
      <dropdown-input id="menu"
                      placeholder="Report"
                      value="[[report]]"
                      options="[[reportOptions]]"
                      is-focused="[[isMenuFocused]]"
                      on-input-focus="onMenuFocus_"
                      on-input-blur="onMenuBlur_"
                      on-input-keydown="onMenuKeydown_"
                      on-clear="onMenuClear_"
                      on-option-select="onMenuSelect_">
      </dropdown-input>

      <div id="milestones">
        <paper-button hidden$="[[!isPreviousMilestone]]"
            on-tap="previousMilestone_">
          M[[previousMilestone]]
          <iron-icon icon="chevron-left"></iron-icon>
        </paper-button>

        <div id="current_milestone">
          M[[milestone]]
        </div>

        <paper-button hidden$="[[!isNextMilestone]]"
            on-tap="nextMilestone_">
          <iron-icon icon="chevron-right"></iron-icon>
          M[[nextMilestone]]
        </paper-button>
      </div>

      <paper-icon-button icon="close"
                         on-tap="closeSection_"></paper-icon-button>
    </div>

    <div id="tables">
      <dom-repeat items="[[tables]]">
        <template>
          <div>
            <h2>[[item.title]]</h2>

            <table>
              <thead>
                <th colspan="2">&nbsp;</th>
                <th>Current<br>[[item.currentVersion]]</th>
                <th>Reference<br>[[item.referenceVersion]]</th>
                <th colspan="2">Change</th>
              </thead>
              <tbody>
                <!-- TODO why doesn't <dom-repeat> work for tr or td? -->
                <template is="dom-repeat" items="[[item.rows]]">
                  <tr>
                    <template is="dom-if" if="[[item.isFirstInCategory]]">
                      <th row-span="[[item.rowCount]]"
                          even-category$="[[item.evenCategory]]">
                        [[item.category]]
                      </th>
                    </template>

                    <th class="name_column">
                      <a href="[[item.href]]">[[item.name]]</a>
                    </th>

                    <td>
                      <tr-v-ui-scalar-span value="[[item.currentValue]]"
                                            unit="[[item.unit]]">
                      </tr-v-ui-scalar-span>
                    </td>

                    <td>
                      <tr-v-ui-scalar-span value="[[item.referenceValue]]"
                                            unit="[[item.unit]]">
                      </tr-v-ui-scalar-span>
                    </td>

                    <td>
                      <tr-v-ui-scalar-span value="[[item.percentDeltaValue]]"
                                            unit="[[item.percentDeltaUnit]]">
                      </tr-v-ui-scalar-span>
                    </td>

                    <td>
                      <tr-v-ui-scalar-span value="[[item.deltaValue]]"
                                            unit="[[item.deltaUnit]]">
                      </tr-v-ui-scalar-span>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </template>
      </dom-repeat>
    </div>

    <!-- TODO buttons to add alerts sections for this report -->
  </template>
</dom-module>

<script>
'use strict';
tr.exportTo('cp.rs', () => {
  class ReleasingSection extends cp.Element {
    static get is() { return 'releasing-section'; }

    static get actions() { return cp.rs.ACTIONS; }

    static get properties() {
      return Object.assign(cp.sectionProperties({
        isLoading: {type: Boolean},
        report: {type: String},
        isMenuFocused: {type: Boolean},
        reportOptions: {type: Array},
        milestone: {type: Number},
        isPreviousMilestone: {type: Boolean},
        isNextMilestone: {type: Boolean},
        tables: {type: Array},
      }), {
        previousMilestone: {
          type: Number,
          computed: 'plus_(milestone, -1)',
        },

        nextMilestone: {
          type: Number,
          computed: 'plus_(milestone, 1)',
        },
      });
    }

    plus_(x, y) {
      return x + y;
    }

    closeSection_() {
      this.dispatch({
        type: 'closeSection',
        sectionId: this.sectionId,
      });
    }

    onMenuFocus_() {
      this.dispatch({
        type: 'releasingMenuFocus',
        sectionId: this.sectionId,
        isMenuFocused: true,
      });
    }

    onMenuBlur_() {
      this.dispatch({
        type: 'releasingMenuFocus',
        sectionId: this.sectionId,
        isMenuFocused: false,
      });
    }

    onMenuKeydown_(e) {
      this.dispatch({
        type: 'releasingMenuKeydown',
        sectionId: this.sectionId,
        report: e.detail.value,
      });
    }

    onMenuClear_() {
      this.dispatch({
        type: 'releasingMenuClear',
        sectionId: this.sectionId,
      });
    }

    onMenuSelect_() {
      this.dispatch({
        type: 'releasingMenuSelect',
        sectionId: this.sectionId,
        report: this.$.menu.value,
      });
    }

    previousMilestone_() {
      this.dispatch({
        type: 'releasingMilestone',
        sectionId: this.sectionId,
        milestone: this.milestone - 1,
      });
    }

    nextMilestone_() {
      this.dispatch({
        type: 'releasingMilestone',
        sectionId: this.sectionId,
        milestone: this.milestone + 1,
      });
    }
  }
  customElements.define(ReleasingSection.is, ReleasingSection);

  return {
  };
});
</script>
