<!DOCTYPE html>
<!--
Copyright 2017 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<dom-module id="multi-chart">
  <template>
    <style>
      :host {
        display: flex;
      }

      #right {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
      }

      #x_brush_handles {
        position: relative;
        height: 15px;
      }

      #y_brush_handles {
        position: relative;
        width: 15px;
      }

      .brush_handle {
        position: absolute;
        cursor: move;
      }

      .x_brush_handle {
        top: 0;
      }

      .y_brush_handle {
        right: 0;
      }

      .brush_handle path {
        fill: rgba(0, 0, 0, 0.3);
      }

      path {
        vector-effect: non-scaling-stroke;
      }

      rect {
        opacity: 0.05;
      }

      #yaxis {
        margin-right: 3px;
        margin-top: 15px;
      }

      #xaxis {
        margin-top: 3px;
      }

      #xaxis, #yaxis {
        user-select: none;
      }

      line {
        stroke-width: 1;
        stroke: #ccc;
      }

      circle:hover {
        opacity: 1;
      }

      #main {
        position: relative;
      }

      #tooltip {
        background-color: white;
        border-style: solid;
        border-width: 2px;
        padding: 8px;
        position: absolute;
        white-space: nowrap;
        z-index: 100;
      }

      .icon {
        transform: translate(-12px, -12px);
      }

      .icon iron-icon {
        position: static;
      }
    </style>

    <svg id="yaxis"
         width$="[[yAxisWidth]]"
         height$="[[height]]">
      <template is="dom-repeat" items="[[yAxisTicks]]" as="tick">
        <text x$="[[tick.x]]"
              y$="[[tick.y]]"
              alignment-baseline="middle">
          [[tick.text]]
        </text>
      </template>
    </svg>

    <div id="right">
      <div id="x_brush_handles">
        <template is="dom-repeat" items="[[xBrushes]]" as="brush" index-as="brushIndex">
          <div class="brush_handle x_brush_handle"
               on-track="onTrackBrushHandle_"
               style$="left: calc([[brush.x]] - 5px)">
            <svg height="15" width="10" viewBox="0 0 2 3">
              <path d="M0,0 L2,0 L2,2 L1,3 L0,2">
              </path>
            </svg>
          </div>
        </template>
      </div>

      <div id="main">
        <svg width="100%"
             height$="[[graphHeight]]"
             preserveAspectRatio="none"
             on-tap="onMainClick_">
          <template is="dom-if" if="[[showYAxisTickLines]]">
            <template is="dom-repeat" items="[[yAxisTicks]]" as="tick">
              <line x1="0"
                    x2="100%"
                    y1$="[[tick.y]]"
                    y2$="[[tick.y]]">
              </line>
            </template>
          </template>

          <template is="dom-if" if="[[showXAxisTickLines]]">
            <template is="dom-repeat" items="[[xAxisTicks]]" as="tick">
              <line x1$="[[tick.x]]"
                    x2$="[[tick.x]]"
                    y1="0"
                    y2="100%">
              </line>
            </template>
          </template>

          <template is="dom-repeat" items="[[antiBrushes_(xBrushes)]]" as="antiBrush">
            <rect x$="[[antiBrush.start]]"
                  y="0"
                  width$="[[antiBrush.length]]"
                  height="100%">
            </rect>
          </template>

          <template is="dom-repeat" items="[[antiBrushes_(yBrushes)]]" as="antiBrush">
            <rect x="0"
                  y$="[[antiBrush.start]]"
                  width="100%"
                  height$="[[antiBrush.length]]">
            </rect>
          </template>

          <template is="dom-repeat" items="[[bars]]" as="bar" index-as="barIndex">
            <svg viewBox="0 0 100 100"
                x="0"
                y="0"
                width="100%"
                height="100%"
                preserveAspectRatio="none">
              <template is="dom-repeat" items="[[bar.data]]" as="datum" index-as="datumIndex">
                <rect x$="[[datum.x]]"
                      y$="[[datum.y]]"
                      width$="[[datum.width]]"
                      height$="[[datum.height]]"
                      on-tap="onBarClick_"
                      on-mouseover="onBarMouseOver_"
                      on-mouseout="onBarMouseOut_">
                </rect>
              </template>
            </svg>
          </template>

          <template is="dom-repeat" items="[[columns]]" as="column" index-as="columnIndex">
            <svg viewBox="0 0 100 100"
                x="0"
                y="0"
                width="100%"
                height="100%"
                preserveAspectRatio="none">
              <template is="dom-repeat" items="[[column.data]]" as="datum" index-as="datumIndex">
                <rect x$="[[datum.x]]"
                      y$="[[datum.y]]"
                      width$="[[datum.width]]"
                      height$="[[datum.height]]"
                      on-tap="onColumnClick_"
                      on-mouseover="onColumnMouseOver_"
                      on-mouseout="onColumnMouseOut_">
                </rect>
              </template>
            </svg>
          </template>

          <template is="dom-repeat" items="[[lines]]" as="line" index-as="lineIndex">
            <svg viewBox="0 0 100 100"
                x="0"
                y="0"
                width="100%"
                height="100%"
                preserveAspectRatio="none">
              <path d$="[[line.path]]"
                    stroke$="[[line.color]]"
                    stroke-width$="[[line.strokeWidth]]"
                    fill="none">
              </path>
            </svg>

            <template is="dom-repeat" items="[[line.data]]" as="datum" index-as="datumIndex">
              <circle cx$="[[datum.x]]"
                      cy$="[[datum.y]]"
                      r$="[[dotRadius]]"
                      fill$="[[line.color]]"
                      cursor$="[[dotCursor]]"
                      opacity="0"
                      on-tap="onDotClick_"
                      on-mouseover="onDotMouseOver_"
                      on-mouseout="onDotMouseOut_">
              </circle>
            </template>

            <template is="dom-repeat" items="[[collectIcons_(line)]]" as="datum">
              <!-- Icons are not on every datum, they're sparse. Save memory by
                  reducing DOM nodes by collecting icons in a single separate
                  dom-repeat.
              -->
              <foreignObject x$="[[datum.x]]"
                             y$="[[datum.y]]"
                             class="icon">
                <body xmlns="http://www.w3.org/1999/xhtml">
                  <iron-icon icon="[[datum.icon]]"
                             on-tap="onDotClick_"
                             on-mouseover="onDotMouseOver_"
                             on-mouseout="onDotMouseOut_">
                  </iron-icon>
                </body>
              </foreignObject>
            </template>
          </template>
        </svg>

        <div id="tooltip"
             hidden$="[[tooltipHidden_(tooltip)]]"
             style$="left: [[tooltip.left]]; right: [[tooltip.right]]; top: [[tooltip.top]]; bottom: [[tooltip.bottom]]; border-color: [[tooltip.color]];">
          <table>
            <template is="dom-repeat" items="[[tooltip.rows]]" as="row" index-as="rowIndex">
              <tr>
                <td>[[row.name]]</td>
                <td>[[row.value]]</td>
              </tr>
            </template>
          </table>
        </div>
      </div>

      <svg id="xaxis"
           width="100%"
           height$="[[xAxisHeight]]">
        <template is="dom-repeat" items="[[xAxisTicks]]" as="tick">
          <text x$="[[tick.x]]"
                y="0"
                text-anchor="middle"
                alignment-baseline="hanging">
            [[tick.text]]
          </text>
        </template>
      </svg>
    </div>
  </template>
</dom-module>
<script src="/dashboard/spa/multi-chart.js"></script>
