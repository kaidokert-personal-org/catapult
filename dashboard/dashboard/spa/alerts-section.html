<!DOCTYPE html>
<!--
Copyright 2017 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="/components/paper-button/paper-button.html">
<link rel="import" href="/components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="/components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="/components/paper-item/paper-item.html">
<link rel="import" href="/components/paper-listbox/paper-listbox.html">
<link rel="import" href="/components/paper-spinner/paper-spinner.html">
<link rel="import" href="/components/paper-toggle-button/paper-toggle-button.html">

<dom-module id="alerts-section">
  <template>
    <style>
      #controls {
        display: flex;
      }

      #menu {
        min-width: 350px;
      }

      paper-toggle-button {
        display: inline-flex;
      }

      #triaged {
        margin-left: 2em;
      }

      .sheriff-item {
        white-space: nowrap;
      }

      #summary {
        flex-grow: 1;
        margin: auto;
        text-align: center;
      }

      #placeholder {
        color: var(--paper-grey-500);
        position: relative;
      }

      #spinner_container {
        bottom: 0;
        display: flex;
        height: 100%;
        position: absolute;
        width: 100%;
      }

      paper-spinner {
        margin: auto;
      }

      #placeholder table {
        width: 100%;
      }

      table {
        border-collapse: collapse;
      }

      table thead th {
        background-color: #e8eaf6;
      }

      table tbody tr:nth-child(even) {
        background: rgba(232, 234, 246, 0.5);
      }

      td {
        padding: 0.5em;
      }

      th.delta_pct {
        padding-right: 0.5em;
      }

      td.delta,
      td.delta_pct {
        text-align: right;
      }

      paper-button.expand_group {
        font-size: x-large;
        line-height: 0;
        margin: 0;
        min-width: 0;
        padding: 0;
      }

      .collapse_row_up_arrow {
        position: relative;
        bottom: -12px;
      }
    </style>

    <div id="controls">
      <paper-dropdown-menu id="menu"
                           label="Sheriff"
                           on-iron-select="onMenuSelect_">
        <paper-listbox slot="dropdown-content" selected="{{selectedSheriffIndex}}">
          <template is="dom-repeat" items="[[sheriffList]]">
            <paper-item label="[[item]]" class="sheriff-item">[[item]]</paper-item>
          </template>
        </paper-listbox>
      </paper-dropdown-menu>

      <span id="summary">[[summary]]</span>

      <paper-toggle-button id="improvements"
                          checked$="[[showingImprovements]]"
                          on-change="toggleShowingImprovements_">
        Improvements
      </paper-toggle-button>

      <paper-toggle-button id="triaged"
                    checked$="[[showingTriaged]]"
                    on-change="toggleShowingTriaged_">
        Triaged
      </paper-toggle-button>

      <paper-icon-button icon="close"
                         on-tap="closeSection_"></paper-icon-button>
    </div>

    <template is="dom-if" if="[[!any_(rows)]]">
      <div id="placeholder">
        <table>
          <thead>
            <tr>
              <th>xxx</th>
              <th>xxx</th>
              <th>xxx</th>
              <th>xxx</th>
              <th>xxx</th>
            </tr>
          </thead>
          <tbody>
            <template is="dom-repeat" items="[[placeholderRows_()]]">
              <tr>
                <td>xxx</td>
                <td>xxx</td>
                <td>xxx</td>
                <td>xxx</td>
                <td>xxx</td>
              </tr>
            </template>
          </tbody>
        </table>

        <div id="spinner_container">
          <paper-spinner active$="[[isLoading]]"></paper-spinner>
        </div>
      </div>
    </template>

    <template is="dom-if" if="[[any_(rows)]]">
      <table>
        <thead>
          <tr>
            <th>&nbsp;</th>
            <th><paper-checkbox></paper-checkbox></th>
            <th>Revisions</th>
            <th>Bot</th>
            <th>Test Suite</th>
            <th colspan="5">Test</th>
            <th>Delta</th>
            <th class="delta_pct">Delta %</th>
          </tr>
        </thead>

        <tbody>
          <template is="dom-repeat" items="[[rows]]">
            <tr>
              <td>
                <template is="dom-if" if="[[item.numGroupMembers]]">
                  <paper-button class="expand_group"
                                on-tap="toggleGroupExpanded_">
                    <template is="dom-if" if="[[item.isGroupExpanded]]">
                      <div class="collapse_row_up_arrow">&#8963;</div>
                    </template>
                    <template is="dom-if" if="[[!item.isGroupExpanded]]">
                      <div>&#8964;</div>
                    </template>
                  </paper-button>
                  [[item.numGroupMembers]]
                </template>
              </td>
              <td><paper-checkbox></paper-checkbox></td>
              <td>[[item.revisions]]</td>
              <td>[[item.bot]]</td>
              <td>[[item.testSuite]]</td>
              <template is="dom-repeat" items="[[item.testParts]]">
                <td>[[item]]</td>
              </template>
              <td class="delta">[[item.delta]]</td>
              <td class="delta_pct">[[item.deltaPct]]</td>
            </tr>
          </template>
        </tbody>
      </table>
    </template>
  </template>
</dom-module>

<script>
'use strict';
(function() {
class AlertsSection extends ReduxMixin(Polymer.Element) {
  static get is() { return 'alerts-section'; }

  static get actions() { return window.ACTION_CREATORS; }

  static get properties() {
    return Object.assign(
      {sectionId: Number},
      bindSectionState(Boolean, 'isLoading'),
      bindSectionState(String, 'summary'),
      bindSectionState(Array, 'sheriffList'),
      bindSectionState(Boolean, 'showingImprovements'),
      bindSectionState(Boolean, 'showingTriaged'),
      bindSectionState(Array, 'rows'));
  }

  ready() {
    super.ready();
    this.$.menu.open();
  }

  any_(arr) {
    return arr && (arr.length > 0);
  }

  onMenuSelect_(e) {
    this.dispatch('loadAlerts', this.sectionId, e.detail.item.label);
  }

  toggleShowingImprovements_() {
    // TODO this.dispatch('toggleShowingImprovements', this.sectionId);
  }

  toggleShowingTriaged_() {
    // TODO this.dispatch('toggleShowingTriaged', this.sectionId);
  }

  toggleGroupExpanded_(event) {
    const tbody = event.path[6];
    if (tbody.tagName !== 'TBODY') throw 'update event.path index tbody';
    const tr = event.path[5];
    if (tr.tagName !== 'TR') throw 'update event.path index tr';

    this.dispatch({
      type: 'toggleAlertGroupExpanded',
      sectionId: this.sectionId,
      rowIndex: Array.from(tbody.children).indexOf(tr),
    });
  }

  closeSection_() {
    this.dispatch({
      type: 'closeSection',
      sectionId: this.sectionId,
    });
  }

  placeholderRows_() {
    const rows = [];
    for (let i = 0; i < 5; ++i) {
      rows.push({});
    }
    return rows;
  }
}
customElements.define(AlertsSection.is, AlertsSection);
})();
</script>
