<!DOCTYPE html>
<!--
Copyright 2018 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<script src="/bower_components/webcomponentsjs/webcomponents-loader.js"></script>
<script src="/bower_components/web-component-tester/browser.js"></script>
<link rel="import" href="/dashboard/spa/timeseries-request.html">

<script>
'use strict';
suite('TimeseriesRequest', function() {
  test('annotations', () => {
    const request = new cp.TimeseriesRequest({
      levelOfDetail: cp.LEVEL_OF_DETAIL.ANNOTATIONS,
    });
    const expectedColumns =
      'revision,timestamp,avg,count,alert,diagnostics,revisions';
    assert.deepEqual(request.body_.get('columns'), expectedColumns);
  });

  test('postProcess', async() => {
    const unit = tr.b.Unit.byName.unitlessNumber;
    const origFetch = window.fetch;
    window.fetch = async(url, options) => {
      return {
        async json() {
          return {
            units: unit.jsonName,
            data: [
              [1, 1000, 10, 1],
              [2, 2000, 20, 2],
            ],
          };
        }
      };
    };
    const request = new cp.TimeseriesRequest({
      levelOfDetail: cp.LEVEL_OF_DETAIL.XY,
    });
    const response = await request.response;
    assert.lengthOf(response, 2);
    assert.strictEqual(unit, response[0].unit);
    assert.strictEqual(unit, response[1].unit);
    assert.strictEqual(1, response[0].revision);
    assert.strictEqual(2, response[1].revision);
    assert.strictEqual(1000, response[0].timestamp.getTime());
    assert.strictEqual(2000, response[1].timestamp.getTime());
    assert.strictEqual(10, response[0].avg);
    assert.strictEqual(20, response[1].avg);
    assert.strictEqual(1, response[0].count);
    assert.strictEqual(2, response[1].count);
    window.fetch = origFetch;
  });
});
</script>
